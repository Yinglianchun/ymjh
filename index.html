<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>一梦江湖简历卡</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.min.js"></script>
  <style>
    :root { color-scheme: light; }
    body{
      background:#f0f2f5;
      font-family:system-ui,-apple-system,"Segoe UI","PingFang SC","Microsoft YaHei","Noto Sans SC","Helvetica Neue",Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .card{ background:#fff; border-radius:24px; box-shadow:0 10px 30px -5px rgba(0,0,0,.08); position:relative; overflow:hidden; }
    .bg-deco{ position:absolute; inset:0; pointer-events:none; z-index:0; }
    .tag{ font-size:.75rem; padding:3px 8px; border-radius:6px; display:inline-block; margin:0 6px 6px 0; white-space:nowrap; font-weight:600; }
    /* 卡片宽度加大，避免六个字被截断 */
    #card-preview{ width:460px; }
    .skill-row{border:1px solid #e5e7eb; border-radius:8px; padding:8px; display:flex; align-items:center; gap:8px; background:#fff;}
    .skill-row.active{border-color:#fbbf24; background:#fffbeb;}
    /* File input pretty (no emoji) */
    .filebox input[type="file"]{ display:none; }
    .filebtn{ display:inline-flex; align-items:center; padding:.5rem .75rem; border-radius:.5rem; background:#0f172a; color:#fff; font-weight:600; font-size:.875rem; }
    .filebtn:hover{ filter:brightness(1.05); }
    .filename{ font-size:.75rem; color:#64748b; margin-left:.5rem; }
    /* Six-attribute card — flat minimal */
    .qmark{width:22px;height:22px;line-height:22px;text-align:center;
      font-family:"Noto Serif SC","Noto Serif",Georgia,"Times New Roman",serif;
      font-weight:700;font-size:22px;color:#e2e8f0;display:inline-block;}
    .stat{ background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px; text-align:center; transition:all .18s ease; }
    .stat .k{ font-size:10px; color:#94a3b8; margin-bottom:4px; letter-spacing:.3px; }
    .stat .v{ font-size:14px; font-weight:800; color:#0f172a; }
    .stat:hover{ border-color:#cbd5e1; box-shadow:0 6px 16px -6px rgba(15,23,42,.15); transform:translateY(-1px); }
    .btn{ background:#0f172a; color:#fff; padding:14px 16px; border-radius:12px; font-weight:700; }
    .btn:disabled{ opacity:.7; }
    .xiuwei-badge{ display:inline-flex !important; align-items:center; gap:6px; white-space:nowrap; }
    
    /* 辅助类：控制显示隐藏 */
    .hidden-force { display: none !important; }
  </style>
</head>
<body class="text-slate-700">
  <div class="container mx-auto p-4 lg:p-8 flex flex-col lg:flex-row gap-8 min-h-screen">
    <!-- 左：配置 -->
    <div class="w-full lg:w-1/2 bg-white p-6 rounded-2xl shadow border border-slate-100 overflow-y-auto max-h-[92vh]">
      <div class="flex items-center gap-2 border-b pb-4 mb-6">
        <div class="w-8 h-8 bg-yellow-100 rounded-full grid place-items-center text-yellow-600">设置</div>
        <h2 class="text-xl font-bold">配置面板</h2>
      </div>

      <div class="space-y-6">
        <!-- 基础信息 -->
        <div class="bg-slate-50 p-4 rounded-xl border">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs text-slate-500">昵称</label>
              <input id="input-name" value="六个字的名称" class="w-full px-3 py-2 bg-white border rounded-lg text-sm"/>
            </div>
            <div>
              <label class="block text-xs text-slate-500">所在赛季</label>
              <input id="input-season" value="天问极" class="w-full px-3 py-2 bg-white border rounded-lg text-sm"/>
            </div>
            <div>
              <label class="block text-xs text-slate-500">等级</label>
              <select id="input-level" class="w-full px-3 py-2 bg-white border rounded-lg text-sm">
                <option value="69">69级</option>
                <option value="89">89级</option>
                <option value="109">109级</option>
                <option value="129">129级</option>
                <option value="149">149级</option>
                <option value="170" selected>170级</option>
              </select>
            </div>
            <div>
              <label class="block text-xs text-slate-500">门派</label>
              <select id="select-sect" class="w-full px-3 py-2 bg-white border rounded-lg text-sm">
                <option>华山</option><option>武当</option><option>云梦</option><option>暗香</option><option>少林</option>
                <option>沧海</option><option>太阴</option><option>伽蓝</option><option>泠音</option><option>关山</option><option>龙门</option><option>大巫</option>
              </select>
            </div>
             <div>
              <label class="block text-xs text-slate-500">职业定位</label>
              <select id="select-role" class="w-full px-3 py-2 bg-white border rounded-lg text-sm font-bold text-indigo-600">
                <option value="dps">输出 / 坦克</option>
                <option value="healer">治疗 (奶妈)</option>
              </select>
            </div>
            <div>
              <label class="block text-xs text-slate-500">麦克风</label>
              <select id="select-mic" class="w-full px-3 py-2 bg-white border rounded-lg text-sm">
                <option>可开麦</option><option selected>听指挥</option><option>闭麦</option>
              </select>
            </div>
            <div class="col-span-2">
              <label class="block text-xs text-slate-500 mb-1">自定义头像</label>
              <div class="filebox inline-flex items-center">
                <label for="input-avatar" class="filebtn">选择头像</label>
                <input type="file" id="input-avatar" accept="image/*"/>
                <span id="file-name" class="filename">未选择文件</span>
              </div>
            </div>
          </div>
        </div>

        <!-- 面板数据 -->
        <div class="bg-slate-50 p-4 rounded-xl border">
          <div class="grid grid-cols-2 gap-4">
            <!-- 通用 -->
            <div><label class="block text-xs text-slate-500">实修（万）</label><input id="input-xiuwei" value="7.9" class="w-full px-3 py-2 bg-white border rounded-lg text-sm"/></div>
            <div><label class="block text-xs text-slate-500">气血</label><input id="input-hp" value="125w" class="w-full px-3 py-2 bg-white border rounded-lg text-sm"/></div>
            
            <!-- DPS 专属 -->
            <div class="role-dps"><label class="block text-xs text-slate-500">主属攻（白）</label><input id="input-main-stat" value="9500" class="w-full px-3 py-2 bg-white border rounded-lg text-sm"/></div>
            
            <!-- 名称变化 -->
            <div><label id="label-max-attack" class="block text-xs text-slate-500">最大内/外攻（白）</label><input id="input-max-attack" value="3.4w" class="w-full px-3 py-2 bg-white border rounded-lg text-sm"/></div>
            
            <!-- 通用 -->
            <div><label class="block text-xs text-slate-500">暴击</label><input id="input-crit" value="2.8w" class="w-full px-3 py-2 bg-white border rounded-lg text-sm"/></div>
            
            <!-- DPS 专属 -->
            <div class="role-dps"><label class="block text-xs text-slate-500">命中</label><input id="input-hit" value="2.8w" class="w-full px-3 py-2 bg-white border rounded-lg text-sm"/></div>
            
            <!-- 通用 -->
            <div><label class="block text-xs text-slate-500">内外防</label><input id="input-defense" value="1.2w" class="w-full px-3 py-2 bg-white border rounded-lg text-sm"/></div>
            
            <!-- 新增格挡 (通用) -->
            <div><label class="block text-xs text-slate-500">格挡 (选填)</label><input id="input-block" placeholder="选填，默认不显示" value="" class="w-full px-3 py-2 bg-white border rounded-lg text-sm"/></div>

            <!-- 奶妈 专属 (已添加默认值) -->
            <div class="role-healer hidden-force"><label class="block text-xs text-slate-500">疗强</label><input id="input-treat-inten" value="9800" class="w-full px-3 py-2 bg-white border rounded-lg text-sm"/></div>
            <div class="role-healer hidden-force"><label class="block text-xs text-slate-500">疗增</label><input id="input-treat-gain" value="950" class="w-full px-3 py-2 bg-white border rounded-lg text-sm"/></div>
          
          </div>
        </div>

        <!-- 特技选择 -->
        <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-100">
          <h3 class="text-sm font-bold text-yellow-700 mb-2">金特技</h3>
          <div id="gold-skills" class="grid grid-cols-1 gap-2 text-xs"></div>
        </div>
        <div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
          <h3 class="text-sm font-bold text-purple-700 mb-2">紫特技</h3>
          <div id="purple-skills" class="grid grid-cols-1 gap-2 text-xs"></div>
        </div>
        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
          <h3 class="text-sm font-bold text-blue-700 mb-2">蓝特技</h3>
          <div id="blue-skills" class="grid grid-cols-1 gap-2 text-xs"></div>
        </div>
        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
          <h3 class="text-sm font-bold text-indigo-700 mb-2">篆铭技</h3>
          <div id="zhuanming-skills" class="grid grid-cols-1 gap-2 text-xs"></div>
        </div>
        <div class="bg-green-50 p-4 rounded-xl border border-green-100">
          <h3 class="text-sm font-bold text-green-700 mb-2">茶铁</h3>
          <div id="tea-skills" class="grid grid-cols-1 gap-2 text-xs"></div>
        </div>

        <!-- 进阶培养 -->
        <div class="bg-slate-50 p-4 rounded-xl border">
            <h3 class="text-sm font-bold text-yellow-700 mb-2">山河器</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div><label class="block text-xs text-slate-500">长烟烽火</label><input id="input-changyan" value="" placeholder="选填" class="w-full px-3 py-2 bg-white border rounded-lg text-sm"/></div>
            <div><label class="block text-xs text-slate-500">关河道远</label><input id="input-guanhe" value="" placeholder="选填" class="w-full px-3 py-2 bg-white border rounded-lg text-sm"/></div>
            <div><label class="block text-xs text-slate-500">骸关断云</label><input id="input-haiguan" value="" placeholder="选填" class="w-full px-3 py-2 bg-white border rounded-lg text-sm"/></div>
          </div>
        </div>

        <div><label class="block text-xs text-slate-500">自我备注</label><textarea id="input-notes" class="w-full px-3 py-2 bg-white border rounded-lg text-sm h-20">副本机制熟练，蹲牢友。</textarea></div>
        <div class="grid grid-cols-2 gap-4">
          <div><label class="block text-xs text-slate-500">在线时间</label><input id="input-play-time" value="每晚 20:00 - 24:00" class="w-full px-3 py-2 bg-white border rounded-lg text-sm"/></div>
        </div>

        <button id="btn" class="w-full btn">生成卡片</button>
      </div>
    </div>

    <!-- 右：预览卡 -->
    <div class="w-full lg:w-1/2 flex flex-col items-center">
      <div class="text-slate-400 text-xs my-4">- 实时预览 -</div>
      <div id="card-preview" class="card text-slate-800">
        <div class="bg-deco">
          <div class="absolute -top-12 -right-12 w-40 h-40 bg-yellow-200/25 rounded-full blur-3xl"></div>
          <div class="absolute -bottom-12 -left-12 w-40 h-40 bg-blue-200/25 rounded-full blur-3xl"></div>
        </div>

        <div class="relative z-10 p-6">
          <div class="flex items-center justify-between mb-2">
            <div class="text-[10px] text-slate-400 tracking-widest font-bold">YIMENG PROFILE</div>
            <div class="h-1.5 w-12 bg-slate-200 rounded-full"></div>
          </div>

          <!-- 左侧信息区宽度加大，避免昵称过长被截断 -->
          <div class="grid grid-cols-[1fr_130px] gap-2 items-start mb-6 pt-2">
            <div class="flex items-start min-w-0 max-w-[280px]">
              <div class="relative mr-4 shrink-0">
                <div class="w-20 h-20 rounded-full bg-slate-900 border-4 border-white shadow overflow-hidden grid place-items-center">
                  <img id="preview-avatar" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQIW2NgYGD4DwABAgEAffh3WQAAAABJRU5ErkJggg==" class="w-full h-full object-cover hidden" alt="avatar"/>
                  <div id="preview-avatar-text" class="text-white font-bold text-xl tracking-widest">华山</div>
                </div>
                <div id="preview-sect-badge" class="absolute -bottom-1 -right-1 bg-yellow-400 text-white text-[10px] px-2 py-0.5 rounded-full border-2 border-white font-bold shadow">华山</div>
              </div>
              <div class="pt-1 min-w-0">
                <h1 id="preview-name" class="text-xl font-bold leading-tight mb-1 truncate">六个字的名称</h1>
                <div class="flex flex-wrap items-center gap-x-1.5 gap-y-1 text-[10px] text-slate-500 mb-2">
                  <span id="preview-season" class="bg-slate-100 px-1.5 py-0.5 rounded">天问极</span>
                  <!-- 等级展示-->
                  <span id="preview-level" class="ml-1">170级</span>
                  <span class="text-slate-300 mx-1">|</span>
                  <span id="preview-mic">听指挥</span>
                </div>
                <div class="bg-yellow-50 xiuwei-badge px-3 py-1 rounded-lg border border-yellow-100">
                  <span class="text-xs text-yellow-600 font-bold">实修</span>
                  <span id="preview-xiuwei" class="text-lg font-black text-yellow-700 leading-none">7.9</span>
                  <span class="text-[10px] text-yellow-600">万</span>
                </div>
              </div>
            </div>
            <div class="relative w-[130px] h-[130px] -mt-2 -mr-2">
              <canvas id="radar" width="130" height="130"></canvas>
            </div>
          </div>

          <!-- 六格属性（简洁扁平 + hover） -->
          <div class="grid grid-cols-3 gap-3 mb-5">
            <div class="stat"><div class="k">气血</div><div id="preview-hp" class="v">125w</div></div>
            <div class="stat"><div class="k">主属攻</div><div id="preview-main-stat" class="v">9500</div></div>
            <div class="stat"><div class="k" id="label-stat-max-atk">大攻</div><div id="preview-max-attack" class="v">3.4w</div></div>
            <div class="stat"><div class="k">暴击</div><div id="preview-crit" class="v">2.8w</div></div>
            <div class="stat"><div class="k">命中</div><div id="preview-hit" class="v">2.8w</div></div>
            <div class="stat"><div class="k">内外防</div><div id="preview-defense" class="v">1.2w</div></div>
            <div class="stat"><div class="k">格挡</div><div id="preview-block" class="v">0</div></div>
            <div class="stat"><div class="k">疗强</div><div id="preview-treat-inten" class="v">0</div></div>
            <div class="stat"><div class="k">疗增</div><div id="preview-treat-gain" class="v">0</div></div>
          </div>

          <!-- 特技展示（仅有勾选时显示） -->
          <div class="space-y-2 mb-4">
            <div id="box-gold" class="hidden"><div class="flex items-start"><span class="text-xs font-bold text-yellow-600 w-12 shrink-0 mt-1.5">金特技</span><div id="out-gold" class="flex-1 flex flex-wrap"></div></div></div>
            <div id="box-purple" class="hidden"><div class="flex items-start"><span class="text-xs font-bold text-purple-600 w-12 shrink-0 mt-1.5">紫特技</span><div id="out-purple" class="flex-1 flex flex-wrap"></div></div></div>
            <div id="box-blue" class="hidden"><div class="flex items-start"><span class="text-xs font-bold text-blue-600 w-12 shrink-0 mt-1.5">蓝特技</span><div id="out-blue" class="flex-1 flex flex-wrap"></div></div></div>
            <div id="box-zm" class="hidden"><div class="flex items-start"><span class="text-xs font-bold text-indigo-600 w-12 shrink-0 mt-1.5">篆铭技</span><div id="out-zm" class="flex-1 flex flex-wrap"></div></div></div>
            <div id="box-tea" class="hidden"><div class="flex items-start"><span class="text-xs font-bold text-green-600 w-12 shrink-0 mt-1.5">茶铁</span><div id="out-tea" class="flex-1 flex flex-wrap"></div></div></div>
          </div>

          <!-- 进阶培养展示 -->
          <div id="box-shanhe" class="grid grid-cols-3 gap-2 mb-4 bg-slate-50 p-2 rounded-lg border">
            <div class="text-center"><div class="text-[10px] text-slate-400 mb-0.5">长烟烽火</div><div id="preview-changyan" class="text-xs font-bold">60级</div></div>
            <div class="text-center border-l border-slate-200"><div class="text-[10px] text-slate-400 mb-0.5">关河道远</div><div id="preview-guanhe" class="text-xs font-bold">60级</div></div>
            <div class="text-center border-l border-slate-200"><div class="text-[10px] text-slate-400 mb-0.5">骸关断云</div><div id="preview-haiguan" class="text-xs font-bold">60级</div></div>
          </div>

          <!-- 备注 -->
          <div class="bg-slate-50 rounded-lg p-3">
            <div class="qmark" aria-hidden="true">“</div>
            <p id="preview-notes" class="text-xs text-slate-600 mt-1">"副本机制熟练，蹲牢友。"</p>
            <div class="mt-2 pt-2 border-t border-slate-200 flex justify-between items-center text-[10px] text-slate-400">
              <span id="preview-play-time">⏰ 每晚 20:00 - 24:00</span><span>DESIGN BY 池又雨/UPDATE BY 金桔乌龙</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
const $ = (id)=>document.getElementById(id);
// transparent 1x1 png (to avoid html-to-image parsing empty <img> issues)
const AVATAR_PLACEHOLDER='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQIW2NgYGD4DwABAgEAffh3WQAAAABJRU5ErkJggg==';
const goldOpts=["偷袭","背水","噬心","镇海冲云"];
const purpleOpts=["暴虐","神力内/外","神力属","妙手","拓源·动如脱兔","拓源·精通","拓源·四海","拓源·醍醐","拓源·精进","拓源·无畏","拓源·凌弱","拓源·破竹","拓源·行云","拓源·流云","拓源·雁行"];
const blueOpts=["行云流水","破竹","动如脱兔","雁行","流云"];
const zmOpts=["青云心","剑歌内","剑歌外","剑歌属","入祸门","自峥嵘","诸恨苦","贯虹"];
const teaOpts=["云炉锻锋","沸血鉴华","行茶问道","一叶留名","烟痕承宗","杯盏窥星","回甘参决"];

// 特技List初始化
function initSkillList(containerId, opts, type){
  const c=$(containerId);
  c.innerHTML = opts.map(name => `
    <div class="skill-row">
      <input type="checkbox" id="${type}-${name}" value="${name}" class="w-4 h-4 accent-slate-600" onchange="toggleSkill(this)"/>
      <label for="${type}-${name}" class="flex-1 cursor-pointer">${name}</label>
      <select id="${type}-lvl-${name}" class="text-xs border rounded bg-slate-50 py-1 px-1 w-16" onchange="updatePreview()">
        <option value="1" selected>1级</option><option value="2">2级</option><option value="3">3级</option><option value="4">4级</option>
      </select>
    </div>
  `).join('');
}
// 篆铭List初始化(篆铭最高为5级)
function initZMList(containerId, opts, type){
  const c=$(containerId);
  c.innerHTML = opts.map(name => `
    <div class="skill-row">
      <input type="checkbox" id="${type}-${name}" value="${name}" class="w-4 h-4 accent-slate-600" onchange="toggleSkill(this)"/>
      <label for="${type}-${name}" class="flex-1 cursor-pointer">${name}</label>
      <select id="${type}-lvl-${name}" class="text-xs border rounded bg-slate-50 py-1 px-1 w-16" onchange="updatePreview()">
        <option value="1" selected>1级</option><option value="2">2级</option><option value="3">3级</option><option value="4">4级</option><option value="5">5级</option>
      </select>
    </div>
  `).join('');
}
// 拨云三沸List初始化(技能最高为5级)
function initTeaList(containerId, opts, type){
  const c=$(containerId);
  c.innerHTML = opts.map(name => `
    <div class="skill-row">
      <input type="checkbox" id="${type}-${name}" value="${name}" class="w-4 h-4 accent-slate-600" onchange="toggleSkill(this)"/>
      <label for="${type}-${name}" class="flex-1 cursor-pointer">${name}</label>
      <select id="${type}-lvl-${name}" class="text-xs border rounded bg-slate-50 py-1 px-1 w-16" onchange="updatePreview()">
        <option value="1" selected>1个</option><option value="2">2个</option><option value="3">3个</option>
      </select>
    </div>
  `).join('');
}
window.toggleSkill=(cb)=>{ cb.closest('.skill-row').classList.toggle('active', cb.checked); updatePreview(); };

function parseVal(s){ if(!s) return 0; const t=s.toString().toLowerCase(); let n=parseFloat(t.replace(/[^0-9.]/g,'')); if(isNaN(n)) n=0; if(/w|万/.test(t)) n*=10000; if(/k|千/.test(t)) n*=1000; return n; }

// 根据等级获取雷达图的最大值配置
function getLevelMaxValues(levelStr) {
    const lv = parseInt(levelStr) || 170; // 默认按照最高等级处理

    // 等级69及以下
    if (lv <= 69) return { 
        hp: 250000, atk: 6900, hit: 4300, crit: 4000, main: 1250, 
        block: 3500, def: 4500, healInten: 1000, healGain: 150 
    };
    // 等级70~89
    if (lv <= 89) return { 
        hp: 350000, atk: 8500, hit: 7000, crit: 7500, main: 2400, 
        block: 4500, def: 5000, healInten: 1500, healGain: 250 
    };
    // 等级90~109
    if (lv <= 109) return { 
        hp: 600000, atk: 13000, hit: 9500, crit: 9700, main: 5700, 
        block: 8000, def: 6800, healInten: 4000, healGain: 400 
    };
    // 等级110~129
    if (lv <= 129) return { 
        hp: 850000, atk: 22000, hit: 14000, crit: 17000, main: 6800, 
        block: 12000, def: 9000, healInten: 4500, healGain: 330 
    };
    // 等级130~149
    if (lv <= 149) return { 
        hp: 1500000, atk: 33000, hit: 23000, crit: 25000, main: 8000, 
        block: 17000, def: 15000, healInten: 9000, healGain: 900 
    };
    
    // 等级150~170及以上
    return { 
        hp: 2800000, atk: 60000, hit: 35000, crit: 35000, main: 12000, 
        block: 32000, def: 30000, healInten: 10000, healGain: 1000 
    };
}

function drawRadar(){
  const c=$('radar'); const ctx=c.getContext('2d'); const w=c.width,h=c.height,cx=w/2,cy=h/2,r=Math.min(w,h)/2-20;
  ctx.clearRect(0,0,w,h);
  
  const role = $('select-role').value;
  const levelStr = $('input-level').value;
  const maxValues = getLevelMaxValues(levelStr);

  let axes = [];
  
  // 提取数值
  const hpVal = parseVal($('input-hp').value);
  const maxAtkVal = parseVal($('input-max-attack').value);
  const critVal = parseVal($('input-crit').value);
  const defVal = parseVal($('input-defense').value);
  const blockVal = parseVal($('input-block').value);
  const mainStatVal = parseVal($('input-main-stat').value);
  const hitVal = parseVal($('input-hit').value);
  const healIntenVal = parseVal($('input-treat-inten').value);
  const healGainVal = parseVal($('input-treat-gain').value);

  // 根据职业分别定义雷达图的轴，使用动态maxValues
  if (role === 'healer') {
     axes.push({label:'气血',max:maxValues.hp,val:hpVal,color:'#e57373'});
     axes.push({label:'疗强',max:maxValues.healInten,val:healIntenVal,color:'#03DE6D'}); // 疗强
     axes.push({label:'内功',max:maxValues.atk,val:maxAtkVal,color:'#ffb74d'});
     axes.push({label:'暴击',max:maxValues.crit,val:critVal,color:'#ba68c8'});
     axes.push({label:'疗增',max:maxValues.healGain,val:healGainVal,color:'#D44267'}); // 疗增
     axes.push({label:'防御',max:maxValues.def,val:defVal,color:'#90a4ae'});
  } else {
     // DPS / Tank
     axes.push({label:'气血',max:maxValues.hp,val:hpVal,color:'#e57373'});
     axes.push({label:'主属',max:maxValues.main,val:mainStatVal,color:'#64b5f6'}); // 主属
     axes.push({label:'大攻',max:maxValues.atk,val:maxAtkVal,color:'#ffb74d'});
     axes.push({label:'暴击',max:maxValues.crit,val:critVal,color:'#ba68c8'});
     axes.push({label:'命中',max:maxValues.hit,val:hitVal,color:'#81c784'}); // 命中
     axes.push({label:'防御',max:maxValues.def,val:defVal,color:'#90a4ae'});
  }
  
  // 如果格挡有数值，则动态加入雷达图（对两种职业都生效）
  if (blockVal > 0) {
      axes.push({label:'格挡',max:maxValues.block,val:blockVal,color:'#607d8b'});
  }

  // 绘图逻辑
  const N=axes.length, ang=2*Math.PI/N;
  ctx.strokeStyle='#e2e8f0'; ctx.lineWidth=1;
  for(let lv=1; lv<=3; lv++){ const rr=r*lv/3; ctx.beginPath(); for(let i=0;i<N;i++){ const a=i*ang-Math.PI/2, x=cx+rr*Math.cos(a), y=cy+rr*Math.sin(a); i?ctx.lineTo(x,y):ctx.moveTo(x,y);} ctx.closePath(); ctx.stroke(); }
  ctx.font='bold 10px system-ui,"PingFang SC","Microsoft YaHei",sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
  for(let i=0;i<N;i++){ const a=i*ang-Math.PI/2; ctx.beginPath(); ctx.moveTo(cx,cy); const ex=cx+r*Math.cos(a),ey=cy+r*Math.sin(a); ctx.lineTo(ex,ey); ctx.stroke();
    const tr=r+12; const tx=cx+tr*Math.cos(a), ty=cy+tr*Math.sin(a); ctx.fillStyle=axes[i].color; ctx.fillText(axes[i].label,tx,ty);
  }
  ctx.beginPath();
  for(let i=0;i<N;i++){
    const a=i*ang-Math.PI/2;
    let t=axes[i].val/axes[i].max;
    t=Math.max(0,Math.min(1,t));
    const rr=r*t; const x=cx+rr*Math.cos(a), y=cy+rr*Math.sin(a);
    i?ctx.lineTo(x,y):ctx.moveTo(x,y);
  }
  ctx.closePath(); ctx.fillStyle='rgba(250,204,21,.3)'; ctx.fill(); ctx.strokeStyle='#eab308'; ctx.lineWidth=1.5; ctx.stroke();
  for(let i=0;i<N;i++){ const a=i*ang-Math.PI/2; let t=axes[i].val/axes[i].max; t=Math.max(0,Math.min(1,t)); const rr=r*t; const x=cx+rr*Math.cos(a), y=cy+rr*Math.sin(a); ctx.beginPath(); ctx.arc(x,y,2,0,Math.PI*2); ctx.fillStyle='#fff'; ctx.fill(); ctx.strokeStyle=axes[i].color; ctx.stroke(); }
}

function updatePreview(){
  const role = $('select-role').value;

  // 1. 切换输入框显示 (DPS vs Healer)
  // 不再清空数据，只是隐藏
  if(role === 'healer'){
    // 隐藏DPS项
    document.querySelectorAll('.role-dps').forEach(el=>el.classList.add('hidden-force'));
    // 显示治疗项
    document.querySelectorAll('.role-healer').forEach(el=>el.classList.remove('hidden-force'));
    
    // 标签更名
    $('label-max-attack').textContent = "最大内功";
    $('label-stat-max-atk').textContent = "内功";
  } else {
    // 默认 DPS
    document.querySelectorAll('.role-dps').forEach(el=>el.classList.remove('hidden-force'));
    document.querySelectorAll('.role-healer').forEach(el=>el.classList.add('hidden-force'));
    
    // 标签更名
    $('label-max-attack').textContent = "最大内/外攻";
    $('label-stat-max-atk').textContent = "大攻";
  }

  // 2. 更新文字内容
  $('preview-name').textContent=$('input-name').value;
  $('preview-season').textContent=$('input-season').value;
  $('preview-level').textContent=$('input-level').value + '级';
  $('preview-sect-badge').textContent=$('select-sect').value;
  $('preview-mic').textContent=$('select-mic').value;
  $('preview-xiuwei').textContent=$('input-xiuwei').value;
  $('preview-hp').textContent=$('input-hp').value; 
  $('preview-main-stat').textContent=$('input-main-stat').value; 
  $('preview-max-attack').textContent=$('input-max-attack').value;
  $('preview-crit').textContent=$('input-crit').value;
  $('preview-hit').textContent=$('input-hit').value;
  $('preview-defense').textContent=$('input-defense').value;
  $('preview-treat-inten').textContent = $('input-treat-inten').value;
  $('preview-treat-gain').textContent=$('input-treat-gain').value;
  $('preview-block').textContent=$('input-block').value; // 格挡
  
  const cy = $('input-changyan').value;
  const gh = $('input-guanhe').value;
  const hg = $('input-haiguan').value;
  $('preview-changyan').textContent = cy;
  $('preview-guanhe').textContent = gh;
  $('preview-haiguan').textContent = hg;
  
  // 山河器显示逻辑：如果三个都为空，则隐藏整个区域
  const hasShanhe = cy || gh || hg;
  $('box-shanhe').classList.toggle('hidden', !hasShanhe);

  $('preview-notes').textContent='"'+$('input-notes').value+'"';
  $('preview-play-time').textContent='⏰ '+$('input-play-time').value;

  // 3. 智能显示/隐藏右侧格子的逻辑
  // 核心逻辑：除了格挡是看数值是否为0，其他属性看当前职业是否需要显示
  const show = (id, condition) => {
      const el = $(id);
      if(el && el.parentElement && el.parentElement.classList.contains('stat')) {
          el.parentElement.style.display = condition ? '' : 'none';
      }
  };

  show('preview-hp', true); // 永远显示
  show('preview-max-attack', true); // 永远显示
  show('preview-crit', true); // 永远显示
  show('preview-defense', true); // 永远显示

  // 职业专属显示
  show('preview-main-stat', role !== 'healer'); // DPS显示主属
  show('preview-hit', role !== 'healer');       // DPS显示命中
  show('preview-treat-inten', role === 'healer'); // 奶妈显示疗强
  show('preview-treat-gain', role === 'healer');  // 奶妈显示疗增
  
  // 选填项显示 (只有格挡是根据数值判断)
  show('preview-block', parseVal($('input-block').value) > 0);

  // 头像
  const fi=$('input-avatar'), img=$('preview-avatar'), txt=$('preview-avatar-text'), fname=$('file-name');
  if(fi && fi.files && fi.files[0]){
    fname.textContent = fi.files[0].name;
    const r=new FileReader(); r.onload=e=>{ img.src=e.target.result; img.classList.remove('hidden'); txt.classList.add('hidden'); }; r.readAsDataURL(fi.files[0]);
  }else{
    fname.textContent = '未选择文件';
    img.classList.add('hidden'); txt.classList.remove('hidden'); txt.textContent=$('select-sect').value;
  }

  drawRadar();
  
  // 特技
  const map=(type, opts, outId, boxId, klass)=>{
    const out=$(outId); out.innerHTML=''; let cnt=0;
    const roman={1:'Ⅰ',2:'Ⅱ',3:'Ⅲ',4:'Ⅳ'};
    opts.forEach(name=>{
      const cb=$(type+'-'+name), lv=$(type+'-lvl-'+name);
      if(cb && cb.checked){
        cnt++;
        const span=document.createElement('span');
        span.className='tag '+klass;
        span.textContent = `${name} ${roman[+lv.value]||lv.value}`;
        out.appendChild(span);
      }
    });
    $(boxId).classList.toggle('hidden', cnt===0);
  };
  map('gold',goldOpts,'out-gold','box-gold','bg-yellow-100 text-yellow-700');
  map('purple',purpleOpts,'out-purple','box-purple','bg-purple-100 text-purple-700');
  map('blue',blueOpts,'out-blue','box-blue','bg-blue-100 text-blue-700');
  map('tea',teaOpts,'out-tea','box-tea','bg-green-100 text-green-700');
  (function(){
    const out=$('out-zm'); out.innerHTML=''; let cnt=0;
    const roman={1:'Ⅰ',2:'Ⅱ',3:'Ⅲ',4:'Ⅳ',5:'Ⅴ'};
    const goldSet=new Set(['诸恨苦','贯虹']);
    zmOpts.forEach(name=>{
      const cb=$('zm-'+name), lv=$('zm-lvl-'+name);
      if(cb && cb.checked){
        cnt++;
        const span=document.createElement('span');
        const klass = goldSet.has(name) ? 'bg-yellow-100 text-yellow-700' : 'bg-indigo-100 text-indigo-700';
        span.className='tag '+klass;
        span.textContent = `${name} ${roman[+lv.value]||lv.value}`;
        out.appendChild(span);
      }
    });
    $('box-zm').classList.toggle('hidden', cnt===0);
  })();
}

// 初始化特技表单
initSkillList('gold-skills', goldOpts, 'gold');
initSkillList('purple-skills', purpleOpts, 'purple');
initSkillList('blue-skills', blueOpts, 'blue');
initZMList('zhuanming-skills', zmOpts, 'zm');
initTeaList('tea-skills', teaOpts, 'tea');

// 绑定更新
document.querySelectorAll('input,select,textarea').forEach(el=>{ el.addEventListener('input',updatePreview); el.addEventListener('change',updatePreview); });
$('input-avatar').addEventListener('change', updatePreview);
updatePreview();


// 导出（所见即所得）
$('btn').addEventListener('click', async ()=>{
  const btn=$('btn'); const keep=btn.textContent; btn.textContent='生成中...'; btn.disabled=true;
  try{
    const node=$('card-preview');
    const dataUrl = await htmlToImage.toPng(node, { pixelRatio: 3, backgroundColor: '#ffffff', cacheBust: true });
    const a=document.createElement('a'); const name=$('input-name').value; const sect=$('select-sect').value;
    a.download=`一梦江湖_${sect}_${name}_简历卡.png`; a.href=dataUrl; a.click();
  }catch(e){ console.error(e); alert('生成失败，再点一次'); }
  finally{ btn.textContent=keep; btn.disabled=false; }
});
</script>
</body>
</html>